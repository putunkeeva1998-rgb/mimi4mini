<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mimi 4 mini</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --accent: #ff85a2;
            --bg: #fff5f7;
            --card-bg: #ffffff;
            --dark: #2d2d2d; 
            --gray: #a0a0a0; 
            --red: #ff4d6d; 
            --light-pink: rgba(255, 133, 162, 0.1); 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            font-family: 'Montserrat', -apple-system, sans-serif; 
            color: var(--dark); 
            overflow-x: hidden; 
        }
        
        .header { 
            background: #fff; 
            padding: 20px 15px; 
            text-align: center; 
            border-bottom: 2px solid var(--light-pink); 
            position: sticky; 
            top: 0; 
            z-index: 100; 
        }

        .brand-name { 
            font-size: 22px; 
            margin: 0; 
            font-weight: 800; 
            letter-spacing: -0.5px; 
        }

        .container { padding: 15px; padding-bottom: 110px; }

        .cat-row { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .cat-tab { 
            padding: 10px 20px; 
            border-radius: 25px; 
            border: 1.5px solid var(--accent); 
            background: #fff; 
            color: var(--accent); 
            font-size: 11px; 
            font-weight: 800; 
            white-space: nowrap;
            text-transform: uppercase;
        }
        .cat-tab.active { background: var(--accent); color: #fff; }

        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { 
            background: var(--card-bg); 
            border-radius: 20px; 
            overflow: hidden; 
            border: 1px solid rgba(255, 133, 162, 0.2); 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 4px 15px rgba(255, 133, 162, 0.1); 
        }
        
        .slider-wrapper { position: relative; width: 100%; aspect-ratio: 3/4; overflow: hidden; background: #fdfdfd; }
        .slider-inner { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; height: 100%; }
        .slider-inner::-webkit-scrollbar { display: none; }
        .slider-inner img { width: 100%; height: 100%; object-fit: cover; scroll-snap-align: start; flex-shrink: 0; }

        .dots { position: absolute; bottom: 8px; width: 100%; text-align: center; pointer-events: none; }
        .dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin: 0 3px; transition: 0.3s; }

        .fav-heart { 
            position: absolute; top: 10px; right: 10px; z-index: 10; 
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(8px); 
            border-radius: 50%; width: 34px; height: 34px; 
            display: flex; align-items: center; justify-content: center; border: none;
        }
        .fav-heart svg { width: 18px; height: 18px; fill: none; stroke: var(--accent); stroke-width: 2.5px; }
        .fav-heart.active svg { fill: var(--red); stroke: var(--red); }

        .card-info { padding: 12px; text-align: center; }
        .card-title { font-size: 12px; font-weight: 700; margin-bottom: 6px; height: 30px; overflow: hidden; line-height: 1.2; }
        .card-price { color: var(--accent); font-weight: 800; font-size: 16px; margin-bottom: 10px; }
        
        .size-btns { display: flex; justify-content: center; gap: 4px; margin-bottom: 12px; }
        .s-btn { flex: 1; padding: 8px 0; border: 1px solid #eee; border-radius: 8px; font-size: 11px; font-weight: 800; background: #fff; }
        .s-btn.active { border-color: var(--accent); background: var(--light-pink); color: var(--accent); }

        .buy-btn { 
            width: 100%; padding: 12px; background: var(--accent); color: #fff; 
            border: none; border-radius: 12px; font-size: 10px; font-weight: 800; 
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff; 
            display: flex; justify-content: space-around; padding: 10px 0 25px 0; 
            border-top: 1px solid var(--light-pink); z-index: 1000; 
        }
        .nav-item { border: none; background: none; color: var(--gray); display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 5px; width: 25%; font-weight: 600; }
        .nav-item.active { color: var(--accent); }
        .nav-item svg { width: 24px; height: 24px; fill: currentColor; }

        .modal { position: fixed; inset: 0; background: #fff; z-index: 2000; overflow-y: auto; padding-bottom: 40px; }
        .close-m { position: fixed; top: 15px; left: 15px; width: 40px; height: 40px; border-radius: 50%; background: #fff; border: 1px solid #eee; z-index: 2100; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        .input-c { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #eee; font-size: 15px; background: #fdfdfd; font-family: inherit; }
        .order-btn { width: 100%; padding: 18px; background: var(--accent); color: #fff; border: none; border-radius: 18px; font-weight: 800; font-size: 16px; margin-top: 20px; box-shadow: 0 5px 15px rgba(255, 133, 162, 0.3); }
        
        #map { width: 100%; height: 250px; border-radius: 15px; margin-top: 10px; border: 1.5px solid var(--accent); }
    </style>
</head>
<body>

<div id="app">
    <div class="header">
        <h1 class="brand-name">mimi 4 mini</h1>
    </div>

    <div class="container">
        <div v-if="activeTab === 'catalog'">
            <div class="cat-row">
                <button v-for="c in categories" @click="currentCat = c; vibrate()" :class="['cat-tab', currentCat === c ? 'active' : '']">{{c}}</button>
            </div>
            <div class="products-grid">
                <div v-for="p in filteredProducts" :key="p.id" class="card">
                    <button class="fav-heart" @click.stop="toggleFav(p)" :class="{active: isFav(p)}">
                        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </button>
                    <div class="slider-wrapper" @click="openP(p)">
                        <div class="slider-inner" @scroll="e => handleScroll(e, p)">
                            <img v-for="img in p.images" :src="img">
                        </div>
                        <div class="dots">
                            <span v-for="(img, idx) in p.images" class="dot" :style="{ background: idx === p.aIdx ? 'var(--accent)' : 'rgba(0,0,0,0.1)' }"></span>
                        </div>
                    </div>
                    <div class="card-info">
                        <div class="card-title">{{p.name}}</div>
                        <div class="card-price">{{p.price}} ‚ÇΩ</div>
                        <div class="size-btns">
                            <button v-for="s in p.sizes" @click="p.selS = s; vibrate()" :class="['s-btn', p.selS === s ? 'active' : '']">{{s}}</button>
                        </div>
                        <button class="buy-btn" @click="addToCart(p)">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'favs'">
            <h2 class="brand-name" style="font-size: 18px; margin-bottom: 20px;">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
            <div v-if="favItems.length === 0" style="text-align: center; padding: 50px 0; color: var(--gray); font-size: 14px;">–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ ‚ù§Ô∏è</div>
            <div class="products-grid">
                <div v-for="p in favItems" :key="p.id" class="card">
                    <button class="fav-heart active" @click.stop="toggleFav(p)">
                        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </button>
                    <div class="slider-wrapper">
                        <div class="slider-inner" @scroll="e => handleScroll(e, p)">
                            <img v-for="img in p.images" :src="img">
                        </div>
                        <div class="dots">
                            <span v-for="(img, idx) in p.images" class="dot" :style="{ background: idx === p.aIdx ? 'var(--accent)' : 'rgba(0,0,0,0.1)' }"></span>
                        </div>
                    </div>
                    <div class="card-info">
                        <div class="card-price">{{p.price}} ‚ÇΩ</div>
                        <div style="font-size: 10px; color: var(--gray); margin-bottom: 8px; font-weight: 700;">–†–∞–∑–º–µ—Ä: {{p.selS}}</div>
                        <button class="buy-btn" @click="addToCart(p)">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'cart'">
            <h2 class="brand-name" style="font-size: 18px; margin-bottom: 20px;">–ö–æ—Ä–∑–∏–Ω–∞</h2>
            <div v-if="cart.length === 0" style="text-align: center; padding: 50px 0; color: var(--gray);">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
            <div v-else>
                <div v-for="item in cart" :key="item.cartId" style="display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid #eee;">
                    <img :src="item.img" style="width: 70px; height: 90px; object-fit: cover; border-radius: 12px;">
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 700;">{{item.name}}</div>
                        <div style="font-size: 11px; color: var(--gray);">–†–∞–∑–º–µ—Ä: {{item.size}}</div>
                        <div style="color: var(--accent); font-weight: 800; margin-top: 5px;">{{item.price}} ‚ÇΩ</div>
                    </div>
                    <button @click="removeC(item.cartId)" style="border:none; background:none; font-size:18px; color: var(--gray);">‚úï</button>
                </div>

                <div style="margin-top: 25px;">
                    <input class="input-c" v-model="form.name" placeholder="–í–∞—à–µ –∏–º—è" style="margin-bottom:10px;">
                    <input class="input-c" v-model="form.phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" type="tel" style="margin-bottom:15px;">
                    <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                        <button v-for="d in ['–°–î–≠–ö', '–ü–æ—á—Ç–∞', '5post']" 
                            @click="deliv = d; vibrate(); initMap();"
                            :class="['cat-tab', deliv === d ? 'active' : '']" 
                            style="flex:1;">
                            {{d}}
                        </button>
                    </div>

                    <div v-show="deliv">
                        <div style="font-size: 11px; margin-bottom: 5px; font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                            <span>üìç {{address || '–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞ –∫–∞—Ä—Ç–µ'}}</span>
                            <button @click="locateMe" style="border:none; background:rgba(255,133,162,0.1); color:var(--accent); font-weight:800; font-size:10px; padding: 5px 10px; border-radius: 8px;">–ì–î–ï –Ø?</button>
                        </div>
                        <div id="map"></div>
                    </div>
                </div>
                <button class="order-btn" @click="send" :disabled="!isValid">–û–§–û–†–ú–ò–¢–¨: {{total}} ‚ÇΩ</button>
            </div>
        </div>

        <div v-if="activeTab === 'profile'">
            <div style="text-align: center; padding: 40px 0;">
                <img :src="user.photo || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent); padding: 3px;">
                <h2 style="margin-top: 15px;">{{user.first_name}}</h2>
                <p style="font-size: 12px; color: var(--gray); margin-bottom: 25px;">–ö–ª–∏–µ–Ω—Ç mimi 4 mini</p>
                <button class="cat-tab" @click="tg.openTelegramLink('https://t.me/optania')">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</button>
            </div>
        </div>
    </div>

    <div v-if="selP" class="modal">
        <button class="close-m" @click="selP = null">‚úï</button>
        <div class="slider-wrapper" style="aspect-ratio: 1/1.2;">
            <div class="slider-inner" @scroll="e => handleScroll(e, selP)">
                <img v-for="img in selP.images" :src="img">
            </div>
            <div class="dots">
                <span v-for="(img, idx) in selP.images" class="dot" :style="{ background: idx === selP.aIdx ? 'var(--accent)' : 'rgba(0,0,0,0.1)' }"></span>
            </div>
        </div>
        <div style="padding: 20px;">
            <h2 class="brand-name" style="font-size: 20px;">{{selP.name}}</h2>
            <div style="font-size: 24px; color: var(--accent); font-weight: 800; margin: 10px 0;">{{selP.price}} ‚ÇΩ</div>
            <p style="font-size: 13px; color: #666; line-height: 1.6;">{{selP.desc}}</p>
            <div class="size-btns" style="margin: 25px 0;">
                <button v-for="s in selP.sizes" @click="selP.selS = s; vibrate()" :class="['s-btn', selP.selS === s ? 'active' : '']" style="padding: 15px;">{{s}}</button>
            </div>
            <button class="order-btn" @click="addToCart(selP)">–í –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <button @click="activeTab = 'catalog'; vibrate()" :class="['nav-item', activeTab === 'catalog' ? 'active' : '']">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button @click="activeTab = 'favs'; vibrate()" :class="['nav-item', activeTab === 'favs' ? 'active' : '']">
            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
        </button>
        <button @click="activeTab = 'cart'; vibrate()" :class="['nav-item', activeTab === 'cart' ? 'active' : '']">
            <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg><span>–ö–æ—Ä–∑–∏–Ω–∞</span>
        </button>
        <button @click="activeTab = 'profile'; vibrate()" :class="['nav-item', activeTab === 'profile' ? 'active' : '']">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
    </nav>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                activeTab: 'catalog',
                currentCat: '–ö–ê–†–ù–ê–í–ê–õ–¨–ù–´–ï –ü–õ–ê–¢–¨–Ø',
                categories: ['–ö–ê–†–ù–ê–í–ê–õ–¨–ù–´–ï –ü–õ–ê–¢–¨–Ø', '–ü–û–í–°–ï–î–ù–ï–í–ù–´–ï –ü–õ–ê–¢–¨–Ø'],
                selP: null,
                deliv: '',
                address: '',
                map: null,
                markers: [],
                selectedPVZ: null,
                user: { first_name: '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å', photo: '' },
                form: { name: '', phone: '' },
                products: [
                    { id: 1, category: '–ö–ê–†–ù–ê–í–ê–õ–¨–ù–´–ï –ü–õ–ê–¢–¨–Ø', name: '–ü–ª–∞—Ç—å–µ "–≠–ª—å–∑–∞ 1023"', price: 1290, images: ['elsa1023.jpg', 'elsa1023(2).jpg'], sizes: ['100','110','120','130','140'], selS: '100', aIdx: 0, desc: '–î–µ—Ç—Å–∫–∏–π –∫–∞—Ä–Ω–∞–≤–∞–ª—å–Ω—ã–π –∫–æ—Å—Ç—é–º –≠–ª—å–∑—ã...' },
                    { id: 2, category: '–ö–ê–†–ù–ê–í–ê–õ–¨–ù–´–ï –ü–õ–ê–¢–¨–Ø', name: '–ü–ª–∞—Ç—å–µ "–≠–ª—å–∑–∞ 0425"', price: 1190, images: ['elsa0425.jpg','elsa0425(2).jpg'], sizes: ['100','110','120','130'], selS: '100', aIdx: 0, desc: '–ü–ª–∞—Ç—å–µ —Å –≠–ª—å–∑–æ–π —Å–æ —à–ª–µ–π—Ñ–æ–º...' },
                    { id: 3, category: '–ö–ê–†–ù–ê–í–ê–õ–¨–ù–´–ï –ü–õ–ê–¢–¨–Ø', name: '–ü–ª–∞—Ç—å–µ "–ü—Ä–∏–Ω—Ü–µ—Å—Å–∞ 0922"', price: 1190, images: ['0922(1).jpg','0922(2).jpg'], sizes: ['110','120','130'], selS: '110', aIdx: 0, desc: '–ö–∞—Ä–Ω–∞–≤–∞–ª—å–Ω—ã–π –∫–æ—Å—Ç—é–º –¥–ª—è –¥–µ–≤–æ—á–∫–∏...' },
                    { id: 4, category: '–ö–ê–†–ù–ê–í–ê–õ–¨–ù–´–ï –ü–õ–ê–¢–¨–Ø', name: '–ü–ª–∞—Ç—å–µ "–†–∞–ø—É–Ω—Ü–µ–ª—å 0825"', price: 1190, images: ['0825(1).jpg','0825(2).jpg'], sizes: ['110','120'], selS: '110', aIdx: 0, desc: '–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ –¥–ª–∏–Ω–Ω–æ–µ –ø—ã—à–Ω–æ–µ –ø–ª–∞—Ç—å–µ...' },
                    { id: 5, category: '–ü–û–í–°–ï–î–ù–ï–í–ù–´–ï –ü–õ–ê–¢–¨–Ø', name: '–ü–ª–∞—Ç—å–µ "–ü—Ä–∏–Ω—Ü–µ—Å—Å–∞"', price: 1890, images: ['pink1.jpg', 'pink2.jpg','pink3.jpg'], sizes: ['98','104','110','122','128','134'], selS: '98', aIdx: 0, desc: '–ù–∞—Ä—è–¥–Ω–æ–µ —è—Ä–∫–æ —Ä–æ–∑–æ–≤–æ–µ –¥–µ—Ç—Å–∫–æ–µ –ø–ª–∞—Ç—å–µ...' },
                    { id: 6, category: '–ü–û–í–°–ï–î–ù–ï–í–ù–´–ï –ü–õ–ê–¢–¨–Ø', name: '–ü–ª–∞—Ç—å–µ "–ü—Ä–∏–Ω—Ü–µ—Å—Å–∞"', price: 1890, images: ['white1.jpg', 'white2.jpg','white3.jpg','white4.jpg'], sizes: ['98','104','110','122','128','134'], selS: '98', aIdx: 0, desc: '–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ –ø–ª–∞—Ç—å–µ –¥–ª—è –¥–µ–≤–æ—á–∫–∏...' }
                ],
                cart: JSON.parse(localStorage.getItem('mimi_cart') || '[]'),
                favs: JSON.parse(localStorage.getItem('mimi_favs') || '[]')
            }
        },
        computed: {
            filteredProducts() { return this.products.filter(p => p.category === this.currentCat) },
            favItems() { 
                return this.favs.map(f => {
                    const product = this.products.find(p => p.id === f.id);
                    return product ? { ...product, selS: f.size } : null;
                }).filter(p => p !== null);
            },
            total() { return this.cart.reduce((s, i) => s + i.price, 0) },
            isValid() { return this.form.name.length > 2 && this.form.phone.length > 9 && this.address && this.cart.length > 0; }
        },
        methods: {
            vibrate() { tg.HapticFeedback.impactOccurred('medium'); },
            handleScroll(e, p) { p.aIdx = Math.round(e.target.scrollLeft / e.target.offsetWidth); },
            toggleFav(p) {
                this.vibrate();
                const idx = this.favs.findIndex(f => f.id === p.id && f.size === p.selS);
                if (idx > -1) { this.favs.splice(idx, 1); } 
                else { this.favs.push({ id: p.id, size: p.selS }); }
                localStorage.setItem('mimi_favs', JSON.stringify(this.favs));
            },
            isFav(p) { return this.favs.some(f => f.id === p.id && f.size === p.selS); },
            openP(p) { this.vibrate(); this.selP = p; },
            addToCart(p) {
                this.vibrate();
                this.cart.push({ cartId: Date.now(), name: p.name, price: p.price, size: p.selS, img: p.images[0] });
                localStorage.setItem('mimi_cart', JSON.stringify(this.cart));
                this.selP = null;
            },
            removeC(id) { 
                this.cart = this.cart.filter(i => i.cartId !== id);
                localStorage.setItem('mimi_cart', JSON.stringify(this.cart));
            },
            initMap() {
                this.$nextTick(() => {
                    setTimeout(() => {
                        if (this.map) { this.map.destroy(); this.map = null; }
                        this.map = new mapgl.Map('map', {
                            center: [37.6175, 55.7558],
                            zoom: 13,
                            key: 'cab82c94-e619-42eb-9814-3361712feaf0',
                        });
                        this.map.on('moveend', () => { this.searchPVZ(); });
                        this.map.on('click', (e) => {
                            this.vibrate();
                            this.getAddress(e.lngLat[1], e.lngLat[0]); 
                        });
                        this.locateMe();
                    }, 200);
                });
            },
            searchPVZ() {
                if (!this.map || !this.deliv) return;
                const center = this.map.getCenter();
                const key = 'cab82c94-e619-42eb-9814-3361712feaf0';
                const queries = {
                    '–°–î–≠–ö': '–°–î–≠–ö –ü–í–ó',
                    '–ü–æ—á—Ç–∞': '–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏ –æ—Ç–¥–µ–ª–µ–Ω–∏—è',
                    '5post': '5Post –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏'
                };

                if (this.markers && this.markers.length > 0) {
                    this.markers.forEach(m => m.destroy());
                    this.markers = [];
                }

                fetch(`https://catalog.api.2gis.com/3.0/items?q=${encodeURIComponent(queries[this.deliv])}&location=${center[0]},${center[1]}&radius=10000&key=${key}`)
                .then(r => r.json())
                .then(d => {
                    if (d.result && d.result.items) {
                        d.result.items.forEach(item => {
                            if (item.point) {
                                const m = new mapgl.Marker(this.map, {
                                    coordinates: [item.point.lon, item.point.lat],
                                });
                                m.on('click', () => {
                                    this.vibrate();
                                    this.selectedPVZ = item; 
                                    this.address = `${this.deliv}: ${item.address_name || item.name}`;
                                });
                                this.markers.push(m);
                            }
                        });
                    }
                }).catch(e => console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:", e));
            },
            getAddress(lat, lon) {
                const key = 'cab82c94-e619-42eb-9814-3361712feaf0';
                fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lat=${lat}&lon=${lon}&fields=items.address&key=${key}`)
                .then(r => r.json())
                .then(d => {
                    if (d.result && d.result.items && d.result.items.length > 0) {
                        const item = d.result.items[0];
                        this.address = item.address_name || item.name || "–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";
                    }
                }).catch(e => console.error("–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–µ—Ä–∞:", e));
            },
            locateMe() {
                if (!navigator.geolocation || !this.map) return;
                navigator.geolocation.getCurrentPosition((pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    this.map.setCenter([lon, lat]);
                    this.map.setZoom(16);
                    this.getAddress(lat, lon); 
                    this.searchPVZ();
                    this.vibrate();
                }, null, { enableHighAccuracy: true });
            },
            send() {
                this.vibrate();
                const now = new Date();
                const dateStr = now.getDate().toString().padStart(2, '0') + 
                                (now.getMonth() + 1).toString().padStart(2, '0') + 
                                now.getFullYear().toString().slice(-2);
                const randomNum = Math.floor(10000 + Math.random() * 90000); 

                const orderData = {
                    order_id: `${dateStr}-${randomNum}`, 
                    user: this.form,
                    cart: this.cart,
                    total: this.total,
                    address: this.address,
                    delivery: this.deliv
                };
                tg.sendData(JSON.stringify(orderData));
                localStorage.removeItem('mimi_cart');
                this.cart = [];
                setTimeout(() => { tg.close(); }, 150);
            }
        },
        mounted() {
            tg.ready(); tg.expand();
            if (tg.initDataUnsafe?.user) {
                const u = tg.initDataUnsafe.user;
                this.user = { first_name: u.first_name, photo: u.photo_url };
                this.form.name = (u.first_name + ' ' + (u.last_name || '')).trim();
            }
        }
    }).mount('#app');
</script>
</body>
</html>
